name: CI - Pruebas y Validación

on:
  pull_request:
    branches: [ "development", "main" ]
  workflow_dispatch:

jobs:
  test-suite:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # ⚡ Caché automático de dependencias

      - name: Configurar Swap (8GB)
        run: |
          sudo swapoff -a
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "✓ Swap configurado: $(free -h | grep Swap)"

      - name: Instalar dependencias del sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends git
          echo "✓ Dependencias del sistema instaladas"

      - name: Instalar dependencias de Python
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install --no-cache-dir -r requirements.txt
          echo "✓ Dependencias de Python instaladas"

      - name: Validar archivos DVC
        run: |
          if [ ! -f dvc.yaml ]; then
            echo " ERROR: dvc.yaml no encontrado"
            exit 1
          fi
          if [ ! -f dvc.lock ]; then
            echo " ERROR: dvc.lock no encontrado"
            exit 1
          fi
          echo "✓ Archivos DVC validados"

      - name: Configurar DVC con Azure
        env:
          AZURE_KEY: ${{ secrets.AZURE_PROJECT_KEY }}
        run: |
          if [ -z "$AZURE_KEY" ]; then
            echo " ERROR: AZURE_PROJECT_KEY no configurado"
            exit 1
          fi
          dvc remote modify azure-storage account_key "$AZURE_KEY" --local
          echo "✓ DVC configurado con Azure"

      - name: Descargar artefactos DVC
        run: |
          echo "Descargando artefactos necesarios para pruebas..."
          dvc pull -v train_logistic train_randomforest
          echo "✓ Artefactos descargados"

      - name: Validar artefactos descargados
        run: |
          if [ ! -d models ]; then
            echo " ERROR: Directorio models/ no existe"
            exit 1
          fi
          
          if [ ! -f models/logistic_regression.pkl ] && [ ! -f models/logistic_regression.joblib ]; then
            echo " WARNING: Modelo logistic_regression no encontrado"
          fi
          
          if [ ! -f models/random_forest.pkl ] && [ ! -f models/random_forest.joblib ]; then
            echo " WARNING: Modelo random_forest no encontrado"
          fi
          
          echo "✓ Estructura de artefactos validada"
          ls -lah models/ || true

      - name: Ejecutar linting (opcional)
        continue-on-error: true
        run: |
          pip install flake8 black
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
          black --check . || true

      - name: Ejecutar pruebas con pytest
        run: |
          pytest tests/ \
            -v \
            --tb=short \
            --maxfail=3 \
            --disable-warnings \
            -ra

      - name: Generar reporte de cobertura
        if: always()
        run: |
          pip install pytest-cov
          pytest tests/ --cov=eq18_turkish_music_mlops --cov-report=term-missing --cov-report=xml || true

      - name: Subir reporte de cobertura
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          fail_ci_if_error: false